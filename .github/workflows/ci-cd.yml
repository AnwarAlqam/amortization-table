name: CI-CD

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

permissions:
  contents: read

env:
  DOTNET_VERSION: '10.0.x'
  NODE_VERSION: '22'
  BACKEND_PROJECT: amortization-table.Server/amortization-table.Server.csproj
  FRONTEND_WORKDIR: amortization-table.client

jobs:
  build-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore backend
        run: dotnet restore $BACKEND_PROJECT

      - name: Build backend
        run: dotnet build $BACKEND_PROJECT -c Release --no-restore

      - name: Publish backend (linux-x64 self-contained)
        run: >
          dotnet publish $BACKEND_PROJECT
          -c Release
          -r linux-x64
          --self-contained true
          -p:PublishSingleFile=true
          -p:IncludeNativeLibrariesForSelfExtract=true
          --no-build
          -o artifacts/backend

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-publish
          path: artifacts/backend
          if-no-files-found: error

  build-frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: amortization-table.client
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: amortization-table.client/package-lock.json

      - name: Install frontend dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build -- --configuration development

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: amortization-table.client/dist/amortization-table.client/browser
          if-no-files-found: error

  deploy-aws:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs:
      - build-backend
      - build-frontend
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-main
      cancel-in-progress: false
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      AWS_STACK_NAME: ${{ vars.AWS_STACK_NAME }}
      PROJECT_NAME: ${{ vars.PROJECT_NAME }}
      ENVIRONMENT_NAME: ${{ vars.ENVIRONMENT_NAME }}
      VPC_CIDR: ${{ vars.VPC_CIDR }}
      PUBLIC_SUBNET_1_CIDR: ${{ vars.PUBLIC_SUBNET_1_CIDR }}
      PUBLIC_SUBNET_2_CIDR: ${{ vars.PUBLIC_SUBNET_2_CIDR }}
      ALLOWED_SSH_CIDR: ${{ vars.ALLOWED_SSH_CIDR }}
      EC2_INSTANCE_TYPE: ${{ vars.EC2_INSTANCE_TYPE }}
      ROOT_VOLUME_SIZE: ${{ vars.ROOT_VOLUME_SIZE }}
      AWS_KEY_PAIR_NAME: ${{ vars.AWS_KEY_PAIR_NAME }}
      ROUTE53_HOSTED_ZONE_ID: ${{ vars.ROUTE53_HOSTED_ZONE_ID }}
      ROUTE53_RECORD_NAME: ${{ vars.ROUTE53_RECORD_NAME }}
      EC2_AMI_ID: ${{ vars.EC2_AMI_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-publish
          path: deploy/backend

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: deploy/frontend

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION != '' && vars.AWS_REGION || 'us-east-1' }}
          role-session-name: github-actions-amortization-deploy

      - name: Show AWS caller
        run: aws sts get-caller-identity

      - name: Deploy infrastructure (CloudFormation)
        shell: bash
        run: |
          set -euo pipefail

          AWS_REGION="${AWS_REGION:-us-east-1}"
          AWS_STACK_NAME="${AWS_STACK_NAME:-amortization-table}"
          PROJECT_NAME="${PROJECT_NAME:-amortization-table}"
          ENVIRONMENT_NAME="${ENVIRONMENT_NAME:-prod}"
          VPC_CIDR="${VPC_CIDR:-10.42.0.0/16}"
          PUBLIC_SUBNET_1_CIDR="${PUBLIC_SUBNET_1_CIDR:-10.42.0.0/24}"
          PUBLIC_SUBNET_2_CIDR="${PUBLIC_SUBNET_2_CIDR:-10.42.1.0/24}"
          ALLOWED_SSH_CIDR="${ALLOWED_SSH_CIDR:-0.0.0.0/0}"
          EC2_INSTANCE_TYPE="${EC2_INSTANCE_TYPE:-t3.micro}"
          ROOT_VOLUME_SIZE="${ROOT_VOLUME_SIZE:-20}"

          PARAMS=(
            "ProjectName=${PROJECT_NAME}"
            "EnvironmentName=${ENVIRONMENT_NAME}"
            "VpcCidr=${VPC_CIDR}"
            "PublicSubnet1Cidr=${PUBLIC_SUBNET_1_CIDR}"
            "PublicSubnet2Cidr=${PUBLIC_SUBNET_2_CIDR}"
            "AllowedSshCidr=${ALLOWED_SSH_CIDR}"
            "Ec2InstanceType=${EC2_INSTANCE_TYPE}"
            "RootVolumeSize=${ROOT_VOLUME_SIZE}"
          )

          if [[ -n "${AWS_KEY_PAIR_NAME:-}" ]]; then
            PARAMS+=("KeyPairName=${AWS_KEY_PAIR_NAME}")
          fi

          if [[ -n "${ROUTE53_HOSTED_ZONE_ID:-}" ]]; then
            PARAMS+=("HostedZoneId=${ROUTE53_HOSTED_ZONE_ID}")
          fi

          if [[ -n "${ROUTE53_RECORD_NAME:-}" ]]; then
            PARAMS+=("RecordName=${ROUTE53_RECORD_NAME}")
          fi

          if [[ -n "${EC2_AMI_ID:-}" ]]; then
            PARAMS+=("AmiId=${EC2_AMI_ID}")
          fi

          aws cloudformation deploy \
            --region "${AWS_REGION}" \
            --stack-name "${AWS_STACK_NAME}" \
            --template-file infra/cloudformation/app-stack.yaml \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides "${PARAMS[@]}"

      - name: Resolve stack outputs
        shell: bash
        run: |
          set -euo pipefail

          AWS_REGION="${AWS_REGION:-us-east-1}"
          AWS_STACK_NAME="${AWS_STACK_NAME:-amortization-table}"

          INSTANCE_ID="$(aws cloudformation describe-stacks \
            --region "${AWS_REGION}" \
            --stack-name "${AWS_STACK_NAME}" \
            --query "Stacks[0].Outputs[?OutputKey=='AppInstanceId'].OutputValue" \
            --output text)"

          BUCKET_NAME="$(aws cloudformation describe-stacks \
            --region "${AWS_REGION}" \
            --stack-name "${AWS_STACK_NAME}" \
            --query "Stacks[0].Outputs[?OutputKey=='DeploymentArtifactsBucketName'].OutputValue" \
            --output text)"

          APP_URL="$(aws cloudformation describe-stacks \
            --region "${AWS_REGION}" \
            --stack-name "${AWS_STACK_NAME}" \
            --query "Stacks[0].Outputs[?OutputKey=='ApplicationUrl'].OutputValue" \
            --output text)"

          echo "INSTANCE_ID=${INSTANCE_ID}" >> "$GITHUB_ENV"
          echo "BUCKET_NAME=${BUCKET_NAME}" >> "$GITHUB_ENV"
          echo "APP_URL=${APP_URL}" >> "$GITHUB_ENV"

      - name: Package app artifacts
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p package
          cp -R deploy/backend package/backend
          cp -R deploy/frontend package/frontend

          PACKAGE_FILE="package-${GITHUB_SHA}.tar.gz"
          tar -czf "${PACKAGE_FILE}" -C package .

          echo "PACKAGE_FILE=${PACKAGE_FILE}" >> "$GITHUB_ENV"
          echo "PACKAGE_KEY=releases/${PACKAGE_FILE}" >> "$GITHUB_ENV"

      - name: Upload deployment package to S3
        shell: bash
        run: |
          set -euo pipefail
          aws s3 cp "${PACKAGE_FILE}" "s3://${BUCKET_NAME}/${PACKAGE_KEY}"

      - name: Wait for EC2 and SSM readiness
        shell: bash
        run: |
          set -euo pipefail

          AWS_REGION="${AWS_REGION:-us-east-1}"

          aws ec2 wait instance-status-ok \
            --region "${AWS_REGION}" \
            --instance-ids "${INSTANCE_ID}"

          for i in {1..30}; do
            PING_STATUS="$(aws ssm describe-instance-information \
              --region "${AWS_REGION}" \
              --filters "Key=InstanceIds,Values=${INSTANCE_ID}" \
              --query "InstanceInformationList[0].PingStatus" \
              --output text 2>/dev/null || true)"

            if [[ "${PING_STATUS}" == "Online" ]]; then
              echo "SSM is online."
              break
            fi

            if [[ "${i}" -eq 30 ]]; then
              echo "Timed out waiting for SSM agent to come online."
              exit 1
            fi

            sleep 10
          done

      - name: Deploy package via SSM
        shell: bash
        run: |
          set -euo pipefail

          AWS_REGION="${AWS_REGION:-us-east-1}"
          PROJECT_NAME="${PROJECT_NAME:-amortization-table}"

          cat > ssm-params.json <<EOF
          {
            "commands": [
              "set -euo pipefail",
              "PROJECT_DIR=/opt/${PROJECT_NAME}",
              "ARTIFACT=/tmp/${GITHUB_SHA}.tar.gz",
              "aws s3 cp s3://${BUCKET_NAME}/${PACKAGE_KEY} \\$ARTIFACT",
              "sudo mkdir -p \\$PROJECT_DIR",
              "sudo tar -xzf \\$ARTIFACT -C \\$PROJECT_DIR",
              "sudo chmod +x \\$PROJECT_DIR/backend/amortization-table.Server || true",
              "sudo systemctl daemon-reload",
              "sudo systemctl restart amortization-table.service",
              "sudo systemctl restart nginx"
            ]
          }
          EOF

          COMMAND_ID="$(aws ssm send-command \
            --region "${AWS_REGION}" \
            --instance-ids "${INSTANCE_ID}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy ${GITHUB_SHA}" \
            --parameters file://ssm-params.json \
            --query "Command.CommandId" \
            --output text)"

          aws ssm wait command-executed \
            --region "${AWS_REGION}" \
            --command-id "${COMMAND_ID}" \
            --instance-id "${INSTANCE_ID}"

          STATUS="$(aws ssm get-command-invocation \
            --region "${AWS_REGION}" \
            --command-id "${COMMAND_ID}" \
            --instance-id "${INSTANCE_ID}" \
            --query "Status" \
            --output text)"

          echo "SSM command status: ${STATUS}"

          if [[ "${STATUS}" != "Success" ]]; then
            aws ssm get-command-invocation \
              --region "${AWS_REGION}" \
              --command-id "${COMMAND_ID}" \
              --instance-id "${INSTANCE_ID}" \
              --output json
            exit 1
          fi

      - name: Deployment summary
        run: |
          echo "Deployment completed."
          echo "Application URL: ${APP_URL}"
